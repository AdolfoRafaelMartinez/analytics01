<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" type="text/css" href="/styles.css" />
</head>
<body>
    <h1>Bitcoin Wallet Generator</h1>
    
    <div class="creation-container">
        <h3>1. Choose a Block Chain</h3>
        <div class="wallet-and-network-container">
            <div class="input-group">
                <label for="network-select">Chain: </label>
                <select id="network-select">
                    <option value="mainnet">Mainnet</option>
                    <option value="testnet" selected>Testnet</option>
                </select>
            </div>
        <hr>
        <h3>2. Choose a Wallet Name</h3>
            <div class="input-group">
                <label for="wallet-name-input">Name:</label>
                <input type="text" id="wallet-name-input" placeholder="Enter wallet name (e.g., 'My First Wallet')">
            </div>
        </div>
        <hr>
        <h3>3. Choose a Mnemonic</h3>
        <p id="mnemonic-p"><%= mnemonic %></p>
        <div class="button-container">
            <button id="generate-btn">Spin Again</button>
        </div>
        <hr>
        <div class="generate-load-container">
            <div class="generate-wallet-section">
                <h3>3. Save & Generate Keys</h3>
                <button id="wallet-btn">Save</button>
            </div>
            <div class="vertical-separator"></div>
        </div>
        <hr>
        <div class="load-wallet-section">
            <h3>Or Load an Existing Wallet</h3>
            <input type="file" id="load-input" accept=".txt,.json">
        </div>
    </div>

    <hr>

    <div id="wallet-info"></div>

    <script>
        let currentWallet = null;

        // --- Event Listeners ---

        window.addEventListener('load', async () => {
            try {
                const response = await fetch('/wallet59.json');
                if (!response.ok) {
                    console.error('Could not load default wallet. Status:', response.status);
                    return;
                }
                const wallet = await response.json();
                const { mnemonic, name, network } = wallet;

                if (!mnemonic) {
                    console.error("Could not find a mnemonic in the default wallet file.");
                    return;
                }

                document.getElementById('mnemonic-p').textContent = mnemonic;
                document.getElementById('wallet-name-input').value = name || '';
                document.getElementById('network-select').value = network || 'testnet';
                await generateWallet(mnemonic, name, network);
            } catch (error) {
                console.error('Error loading default wallet:', error);
            }
        });

        document.getElementById('generate-btn').addEventListener('click', async () => {
            const response = await fetch('/api');
            const data = await response.json();
            const mnemonicP = document.getElementById('mnemonic-p');
            mnemonicP.textContent = data.mnemonic;
            document.getElementById('wallet-info').innerHTML = '';
            document.getElementById('wallet-name-input').value = '';
            currentWallet = null;

            // Add glowing effect
            mnemonicP.classList.add('glowing');
            setTimeout(() => {
                mnemonicP.classList.remove('glowing');
            }, 1000); // 1 second duration for the glow
        });

        document.getElementById('wallet-btn').addEventListener('click', async () => {
            const mnemonic = document.getElementById('mnemonic-p').textContent;
            const name = document.getElementById('wallet-name-input').value;
            const network = document.getElementById('network-select').value;
            
            await generateWallet(mnemonic, name, network);

            // Save functionality merged from save-btn
            if (!currentWallet) {
                // The generateWallet function will display an error, so we just stop.
                return;
            }
            const walletName = document.getElementById('wallet-name-input').value.trim();
            const filename = walletName ? `${walletName.replace(/\s+/g, '_')}.json` : 'wallet.json';
            
            const walletToSave = {
                network: currentWallet.network,
                name: currentWallet.name,
                mnemonic: currentWallet.mnemonic
            };

            const walletString = JSON.stringify(walletToSave, null, 2);
            downloadFile(walletString, filename, 'application/json');
        });

        document.getElementById('load-input').addEventListener('change', () => {
            const input = document.getElementById('load-input');
            if (input.files.length === 0) {
                alert("Please select a file!");
                return;
            }
            const file = input.files[0];
            const reader = new FileReader();

            reader.onload = async (event) => {
                const content = event.target.result;
                let mnemonic;
                let walletName = '';
                let network;
                try {
                    const wallet = JSON.parse(content);
                    mnemonic = wallet.mnemonic;
                    walletName = wallet.name || '';
                    network = wallet.network || 'testnet'; // Get network from wallet file, default to testnet
                    document.getElementById('network-select').value = network; // Set dropdown to loaded network
                } catch (e) {
                    mnemonic = content.trim();
                    network = document.getElementById('network-select').value; // use selected network if it's a plain mnemonic file
                }

                if (!mnemonic) {
                    alert("Could not find a mnemonic in the file.");
                    return;
                }

                document.getElementById('mnemonic-p').textContent = mnemonic;
                document.getElementById('wallet-name-input').value = walletName;
                await generateWallet(mnemonic, walletName, network);
            };

            reader.onerror = (event) => {
                alert("Error reading file: " + event.target.error.name);
            };

            reader.readAsText(file);
        });

        // --- Core Functions ---

        async function generateWallet(mnemonic, name, network) {
            const response = await fetch('/api/wallet', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ mnemonic, name, network }),
            });
            const wallet = await response.json();
            const walletInfoDiv = document.getElementById('wallet-info');

            if (wallet.error) {
                walletInfoDiv.innerHTML = `<p class="error">Error: ${wallet.error}</p>`;
                currentWallet = null;
            } else {
                currentWallet = wallet;
                displayWallet(wallet, walletInfoDiv);
            }
        }

        function displayWallet(wallet, container) {
            const keysTableId = 'keys-table';

            let html = `<h2>Wallet Information</h2>`;
            html += `<p><strong>Name:</strong> ${wallet.name || 'N/A'}</p>`;
            html += `<p><strong>Mnemonic:</strong> ${wallet.mnemonic}</p>`;
            html += `<p><strong>Seed:</strong> ${wallet.seed}</p>`;
            html += `<p><strong>Network:</strong> ${wallet.network}</p>`;
            html += `<p><strong>Root:</strong> ${wallet.root}</p>`;
            
            html += `<h3>Child Keys:</h3>`;
            html += `<p>Click on a private key to reveal/hide it.</p>`;

            html += `<table id="${keysTableId}">`;
            html += `<tr><th>Path</th><th>Address</th><th>Private Key</th><th>Public Key</th></tr>`;
            wallet.childKeys.forEach(key => {
                const path = key.path;
                const pathString = `${path.m}/${path.purpose}/${path.coinType}/${path.account}/${path.change}/${path.index}`;
                html += `<tr>`;
                html += `<td>${pathString}</td>`;
                html += `<td>${key.address}</td>`;
                html += `<td class="sensitive" data-private-key="${key.privateKey}" style="cursor: pointer;">hidden</td>`;
                html += `<td>${key.publicKey}</td>`;
                html += `</tr>`;
            });
            html += `</table>`;
            container.innerHTML = html;

            const privateKeyCells = container.querySelectorAll('.sensitive');
            privateKeyCells.forEach(clickedCell => {
                clickedCell.addEventListener('click', (event) => {
                    event.stopPropagation();
                    const isRevealed = clickedCell.textContent !== 'hidden';
                    
                    // Hide all keys first
                    privateKeyCells.forEach(cell => {
                        cell.textContent = 'hidden';
                    });

                    if (!isRevealed) {
                        clickedCell.textContent = clickedCell.getAttribute('data-private-key');
                    }
                });
            });
        }

        // Global click listener to hide keys when clicking outside
        document.addEventListener('click', () => {
            document.querySelectorAll('.sensitive').forEach(cell => {
                cell.textContent = 'hidden';
            });
        });

        function downloadFile(content, fileName, contentType) {
            const blob = new Blob([content], { type: contentType });
            const anchor = document.createElement('a');
            anchor.download = fileName;
            anchor.href = window.URL.createObjectURL(blob);
            anchor.click();
            window.URL.revokeObjectURL(anchor.href);
        }

    </script>
</body>
</html>