<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin Transaction (P2PKH)</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <a href="/">Home</a>
    <div class="container">
        <h1>Bitcoin Transaction (P2PKH)</h1>
        <div class="form-group">
            <h3>Recommended Miner Fees</h3>
            <p>Fees are in satoshis per virtual byte (sat/vB).</p>
            <ul id="fee-recommendations">
                <li><strong>High Priority:</strong> <span id="fastestFee"></span> sat/vB</li>
                <li><strong>Medium Priority:</strong> <span id="halfHourFee"></span> sat/vB</li>
                <li><strong>Low Priority:</strong> <span id="hourFee"></span> sat/vB</li>
            </ul>
        </div>
        <div class="demo-wrapper">
            <div class="form-column">
                <form id="transactionForm">
                    <div class="form-group">
                        <label for="privateKey">Private Key (Hex):</label>
                        <input type="text" id="privateKey" name="privateKey" placeholder="Enter your 32-byte private key in hexadecimal format" required>
                    </div>
                    <div class="form-group">
                        <label for="fromAddress">From Address:</label>
                        <div style="font-size: 50%; color: #808080; margin-bottom: 2px;">HD Wallet Child #0</div>
                        <input type="text" id="fromAddress" name="fromAddress" readonly>
                    </div>
                    <div class="form-group">
                        <label for="network">Network:</label>
                        <select id="network" name="network">
                            <option value="mainnet">Mainnet</option>
                            <option value="testnet" selected>Testnet</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="toAddress">To Address:</label>
                        <input type="text" id="toAddress" name="toAddress" required>
                    </div>
                    <div class="form-group">
                        <label for="amount">Amount (BTC):</label>
                        <input type="number" step="any" id="amount" name="amount" required>
                    </div>
                    <div class="form-group">
                        <label for="fee">Miner's Fee (BTC):</label>
                        <input type="number" step="any" id="fee" name="fee" value="0.0001" required>
                        <input type="range" id="feeSlider" min="0" max="100" value="50" style="width: 100%;">
                        <div style="text-align: center; margin-top: 5px;"><span id="feePriority">Medium Priority</span></div>
                    </div>
                    <button type="submit" class="btn">Send Transaction</button>
                </form>
            </div>
            <div class="result-column">
                <div id="transactionResult">
                    <p id="successMessage" style="display: none;">Transaction successful! View on explorer:</p>
                    <a id="transactionLink" href="#" target="_blank"></a>
                    <div class="form-group">
                        <label for="transactionId">Transaction ID:</label>
                        <input type="text" id="transactionId" name="transactionId" readonly>
                    </div>
                    <div class="form-group">
                        <label for="confirmations">Confirmations:</label>
                        <span id="confirmations">Waiting for transaction...</span>
                    </div>
                    <div class="form-group">
                        <label for="vsize">Virtual Size:</label>
                        <span id="vsize"></span> vB
                    </div>
                    <div class="form-group">
                        <h3>Transaction Inputs</h3>
                        <pre id="transactionInputs"></pre>
                    </div>
                    <div class="form-group">
                        <h3>Transaction Outputs</h3>
                        <pre id="transactionOutputs"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="/js/transfer_p2pkh_ui.js"></script>
    <script src="/js/bundle.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const networkSelect = document.getElementById('network');
            const fastestFeeSpan = document.getElementById('fastestFee');
            const halfHourFeeSpan = document.getElementById('halfHourFee');
            const hourFeeSpan = document.getElementById('hourFee');
            const feeInput = document.getElementById('fee');
            const feeSlider = document.getElementById('feeSlider');
            const feePrioritySpan = document.getElementById('feePriority');

            let lowFee, highFee;

            const fetchFeeRecommendations = async () => {
                const networkName = networkSelect.value;
                const networkPath = networkName === 'mainnet' ? '' : 'testnet/';
                const apiUrl = `https://mempool.space/${networkPath}api/v1/fees/recommended`;
                try {
                    const response = await fetch(apiUrl);
                    const fees = await response.json();
                    fastestFeeSpan.textContent = fees.fastestFee;
                    halfHourFeeSpan.textContent = fees.halfHourFee;
                    hourFeeSpan.textContent = fees.hourFee;

                    lowFee = fees.hourFee;
                    highFee = fees.fastestFee;

                    updateFeeFromSlider();

                } catch (error) {
                    console.error('Error fetching fee recommendations:', error);
                    fastestFeeSpan.textContent = 'Error';
                    halfHourFeeSpan.textContent = 'Error';
                    hourFeeSpan.textContent = 'Error';
                }
            };
            
            const updateFeeFromSlider = () => {
                if(lowFee && highFee){
                    const sliderValue = feeSlider.value;
                    const feeRange = highFee - lowFee;
                    const calculatedFee = lowFee + (feeRange * (sliderValue / 100));
                    feeInput.value = (calculatedFee / 100000000).toFixed(8);

                    feePrioritySpan.style.padding = '2px 8px';
                    feePrioritySpan.style.borderRadius = '4px';

                    if (sliderValue < 34) {
                        feePrioritySpan.textContent = 'Low Priority';
                        feePrioritySpan.style.backgroundColor = 'red';
                        feePrioritySpan.style.color = 'white';
                    } else if (sliderValue < 67) {
                        feePrioritySpan.textContent = 'Medium Priority';
                        feePrioritySpan.style.backgroundColor = 'yellow';
                        feePrioritySpan.style.color = 'black';
                    } else {
                        feePrioritySpan.textContent = 'High Priority';
                        feePrioritySpan.style.backgroundColor = 'green';
                        feePrioritySpan.style.color = 'white';
                    }
                }
            }
            
            feeSlider.addEventListener('input', updateFeeFromSlider);

            fetchFeeRecommendations();
            networkSelect.addEventListener('change', fetchFeeRecommendations);

            const transactionIdInput = document.getElementById('transactionId');
            const confirmationsSpan = document.getElementById('confirmations');
            const vsizeSpan = document.getElementById('vsize');
            const transactionInputsPre = document.getElementById('transactionInputs');
            const transactionOutputsPre = document.getElementById('transactionOutputs');
            const successMessage = document.getElementById('successMessage');

            let confirmationInterval;
            let txidHasBeenProcessed = false;

            const fetchTransactionDetails = async () => {
                const txid = transactionIdInput.value;
                const networkName = networkSelect.value;
                const networkPath = networkName === 'mainnet' ? '' : 'testnet/';
                const apiUrl = `https://mempool.space/${networkPath}api/`;

                if (!txid) return;

                try {
                    const txResponse = await fetch(`${apiUrl}tx/${txid}`);
                    if (!txResponse.ok) {
                        confirmationsSpan.textContent = 'Awaiting confirmation...';
                        return;
                    }
                    const txData = await txResponse.json();

                    if (txData.status.confirmed) {
                        const tipHeightResponse = await fetch(`${apiUrl}blocks/tip/height`);
                        const tipHeight = await tipHeightResponse.json();
                        const blockHeight = txData.status.block_height;
                        const confirmations = tipHeight - blockHeight + 1;
                        confirmationsSpan.textContent = confirmations;
                    } else {
                        confirmationsSpan.textContent = '0';
                    }

                    vsizeSpan.textContent = txData.vsize;

                    transactionInputsPre.textContent = JSON.stringify(txData.vin, null, 2);
                    transactionOutputsPre.textContent = JSON.stringify(txData.vout, null, 2);

                } catch (error) {
                    console.error('Error fetching transaction details:', error);
                    confirmationsSpan.textContent = 'Error fetching status';
                }
            };
            const txIdObserver = new MutationObserver((mutationsList, observer) => {
                for(const mutation of mutationsList) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'value') {
                        const txid = transactionIdInput.value;
                        if (txid && !txidHasBeenProcessed) {
                            successMessage.style.display = 'block';
                            txidHasBeenProcessed = true;
                            confirmationsSpan.textContent = '0';
                            fetchTransactionDetails();
                            confirmationInterval = setInterval(fetchTransactionDetails, 30000);
                            observer.disconnect();
                        }
                    }
                }
            });

            txIdObserver.observe(transactionIdInput, { attributes: true });
        });
    </script>
</body>
</html>