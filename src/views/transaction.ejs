<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transaction Details</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <a href="/">Home</a>
    <div class="container">
        <h1>Transaction Details</h1>
        <div id="transaction-form">
            <div class="form-group">
                <label for="txid">Transaction ID:</label>
                <input type="text" id="txid" name="txid" value="<%= txid %>" required>
            </div>
            <div class="form-group">
                <label for="network">Network:</label>
                <select id="network" name="network">
                    <option value="mainnet" <%= network === 'mainnet' ? 'selected' : '' %>>Mainnet</option>
                    <option value="testnet" <%= network === 'testnet' ? 'selected' : '' %>>Testnet</option>
                    <option value="testnet4" <%= network === 'testnet4' ? 'selected' : '' %>>Testnet4</option>
                </select>
            </div>
        </div>

        <% 
        let confirmationStyle = '';
        let unconfirmedStyle = '';
        if (details) {
            if (details.status.confirmed) {
                confirmationStyle = 'background-color: #2ECC71; color: white; padding: 10px; border-radius: 5px; margin: 5px 0;';
            } else {
                unconfirmedStyle = 'background-color: #E74C3C; color: white; padding: 10px; border-radius: 5px; margin: 5px 0;';
            }
        }
        %>

        <% if (details) { %>
            <div id="transaction-details">
                <h2>Transaction Details <span style="font-size: 0.7em; color: #888;">(Last Updated: <span id="last-updated" style="background-color: #3498db; color: white; padding: 2px 5px; border-radius: 4px;"></span>)</span></h2>
                <div class="form-group">
                    <label>Transaction ID:</label>
                    <span id="txid-display"><%= details.txid %></span>
                </div>
                <div id="confirmations-group" class="form-group" style="<%= confirmationStyle %>">
                    <label>Confirmations:</label>
                    <span id="confirmations"><%= details.status.confirmed ? details.confirmations : 0 %></span>
                </div>
                <div id="block-height-group" class="form-group" style="<%= unconfirmedStyle %>">
                    <label>Block Height:</label>
                    <span id="block-height"><%- details.status.block_height || 'Unconfirmed' %></span>
                </div>
                <div id="block-hash-group" class="form-group" style="<%= unconfirmedStyle %>">
                    <label>Block Hash:</label>
                    <span id="block-hash"><%- details.status.block_hash || 'Unconfirmed' %></span>
                </div>
                <div id="timestamp-group" class="form-group" style="<%= unconfirmedStyle %>">
                    <label>Timestamp:</label>
                    <span id="timestamp"><%- details.status.block_time ? new Date(details.status.block_time * 1000).toLocaleString() : 'Unconfirmed' %></span>
                </div>
                <div class="form-group">
                    <label>Fee:</label>
                    <span id="fee"><%= (details.fee / 100000000).toFixed(8) %> BTC</span>
                </div>
                <div class="form-group">
                    <label>Virtual Size:</label>
                    <span id="vsize"><%= (details.vsize || details.weight / 4).toFixed(0) %> vB</span>
                </div>
                <h3>Inputs</h3>
                <pre id="vin"><%= JSON.stringify(details.vin, null, 2) %></pre>
                <h3>Outputs</h3>
                <pre id="vout"><%= JSON.stringify(details.vout, null, 2) %></pre>
            </div>
        <% } else { %>
            <div id="transaction-details" style="display: none;">
                <h2>Transaction Details <span style="font-size: 0.7em; color: #888;">(Last Updated: <span id="last-updated" style="background-color: #3498db; color: white; padding: 2px 5px; border-radius: 4px;"></span>)</span></h2>
                <div class="form-group">
                    <label>Transaction ID:</label>
                    <span id="txid-display"></span>
                </div>
                <div id="confirmations-group" class="form-group">
                    <label>Confirmations:</label>
                    <span id="confirmations"></span>
                </div>
                <div id="block-height-group" class="form-group">
                    <label>Block Height:</label>
                    <span id="block-height"></span>
                </div>
                <div id="block-hash-group" class="form-group">
                    <label>Block Hash:</label>
                    <span id="block-hash"></span>
                </div>
                <div id="timestamp-group" class="form-group">
                    <label>Timestamp:</label>
                    <span id="timestamp"></span>
                </div>
                <div class="form-group">
                    <label>Fee:</label>
                    <span id="fee"></span>
                </div>
                <div class="form-group">
                    <label>Virtual Size:</label>
                    <span id="vsize"></span>
                </div>
                <h3>Inputs</h3>
                <pre id="vin"></pre>
                <h3>Outputs</h3>
                <pre id="vout"></pre>
            </div>
        <% } %>
        
        <div id="error-message" class="error-message" style="display: <%= error ? 'block' : 'none' %>;">
            <%= error %>
        </div>
    </div>
    <script>
        const txidInput = document.getElementById('txid');
        const networkInput = document.getElementById('network');
        const lastUpdatedSpan = document.getElementById('last-updated');
        
        const confirmationsGroup = document.getElementById('confirmations-group');
        const confirmationsSpan = document.getElementById('confirmations');
        const blockHeightGroup = document.getElementById('block-height-group');
        const blockHashGroup = document.getElementById('block-hash-group');
        const timestampGroup = document.getElementById('timestamp-group');
        
        let refreshInterval;

        const updateTimestamp = () => {
            lastUpdatedSpan.textContent = new Date().toLocaleTimeString();
        };

        const getConfirmations = async (txData, network) => {
            if (!txData.status.confirmed) return 0;
            try {
                const networkPath = network === 'mainnet' ? '' : `${network}/`;
                const heightUrl = `https://mempool.space/${networkPath}api/blocks/tip/height`;
                const response = await fetch(heightUrl);
                if (!response.ok) return 'N/A';
                const currentHeight = await response.json();
                return currentHeight - txData.status.block_height + 1;
            } catch (e) {
                return 'N/A';
            }
        };
        
        const updateTxStyles = (data, confirmations) => {
            const isConfirmed = data.status.confirmed;
            const unconfirmedStyle = 'background-color: #E74C3C; color: white; padding: 10px; border-radius: 5px; margin: 5px 0;';
            const confirmedStyle = 'background-color: #2ECC71; color: white; padding: 10px; border-radius: 5px; margin: 5px 0;';
            
            confirmationsGroup.style.cssText = isConfirmed ? confirmedStyle : '';
            confirmationsSpan.textContent = isConfirmed ? confirmations : '0';

            [blockHeightGroup, blockHashGroup, timestampGroup].forEach(group => {
                group.style.cssText = isConfirmed ? '' : unconfirmedStyle;
            });

            document.getElementById('block-height').textContent = data.status.block_height || 'Unconfirmed';
            document.getElementById('block-hash').textContent = data.status.block_hash || 'Unconfirmed';
            document.getElementById('timestamp').textContent = data.status.block_time ? new Date(data.status.block_time * 1000).toLocaleString() : 'Unconfirmed';
        };

        const refreshDetails = async () => {
            const txid = txidInput.value.trim();
            const network = networkInput.value;

            if (txid.length !== 64) return;

            try {
                const networkPath = network === 'mainnet' ? '' : `${network}/`;
                const apiUrl = `https://mempool.space/${networkPath}api/tx/${txid}`;
                const response = await fetch(apiUrl);

                if (!response.ok) {
                    console.error('Failed to refresh transaction details.');
                    return;
                }

                const data = await response.json();
                const confirmations = await getConfirmations(data, network);

                updateTxStyles(data, confirmations);

                document.getElementById('vsize').textContent = (data.vsize || data.weight / 4).toFixed(0) + ' vB';
                updateTimestamp();

            } catch (error) {
                console.error('Error refreshing transaction details:', error);
            }
        };

        const fetchDetails = async (isInitialLoad = false) => {
            clearInterval(refreshInterval);
            const txid = txidInput.value.trim();
            const network = networkInput.value;
            const detailsDiv = document.getElementById('transaction-details');
            const errorDiv = document.getElementById('error-message');

            if (txid.length !== 64) return;
            
            if (!isInitialLoad) {
                const url = new URL(window.location.href);
                url.searchParams.set('txid', txid);
                url.searchParams.set('network', network);
                window.history.replaceState({}, '', url);
            }

            detailsDiv.style.display = 'none';
            errorDiv.style.display = 'none';

            try {
                const networkPath = network === 'mainnet' ? '' : `${network}/`;
                const apiUrl = `https://mempool.space/${networkPath}api/tx/${txid}`;
                const response = await fetch(apiUrl);

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Failed to fetch transaction details.');
                }

                const data = await response.json();
                const confirmations = await getConfirmations(data, network);

                document.getElementById('txid-display').textContent = data.txid;
                updateTxStyles(data, confirmations);
                document.getElementById('fee').textContent = (data.fee / 100000000).toFixed(8) + ' BTC';
                document.getElementById('vsize').textContent = (data.vsize || data.weight / 4).toFixed(0) + ' vB';
                document.getElementById('vin').textContent = JSON.stringify(data.vin, null, 2);
                document.getElementById('vout').textContent = JSON.stringify(data.vout, null, 2);

                detailsDiv.style.display = 'block';
                updateTimestamp();
                refreshInterval = setInterval(refreshDetails, 30000);
            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.style.display = 'block';
            }
        };

        txidInput.addEventListener('input', () => fetchDetails());
        networkInput.addEventListener('change', () => fetchDetails());
        
        window.addEventListener('load', () => {
            if (txidInput.value.length === 64) {
                fetchDetails(true);
            }
            updateTimestamp(); // Also set initial timestamp
        });
    </script>
</body>
</html>